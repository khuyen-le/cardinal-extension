---
title: "Cardinal Extension - Exp1"
output: 
  html_document: 
    toc: true
    toc_float: true
date: "2023-03-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE
)
library('tidyverse')
library("purrr")
library("uuid")
library('lubridate')
library('ggplot2')
library('lme4')
library('car')
library('report')
library('ggthemes')
library('emmeans')

library('cowplot')

theme_set(theme_classic())

# The palette with black:
cbPalette <- c("#E69F00", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#56B4E9", "#CC79A7", "#000000")
```

```{r get data}
df.ppt_raw <- read.csv('../../../data/exp1/PROCESSED_DATA/exp1_ppt.csv')
df.trial_raw <- read.csv('../../../data/exp1/PROCESSED_DATA/exp1_trial.csv')
```

## Exclusions
```{r exclusions}
#exclusions go here (or in a separate thing)
# exclude participants who missed more than 1 trial (completed fewer than 5)
ppt_excluded_completion <- df.trial_raw %>% 
  filter(is.na(count)) %>%
  group_by(id) %>%
  summarise(n_no_count = n()) %>%
  filter(n_no_count > 1) %>%
  pull(id)

df.ppt <- df.ppt_raw %>%
  filter(!id %in% ppt_excluded_completion)

exclude <- df.trial_raw %>%
  filter(exclude == "Y") %>%
  count() %>%
  pull(n)

df.trial <- df.trial_raw %>%
  filter(!id %in% ppt_excluded_completion) %>%
  filter(exclude != "Y") 
```

```{r refactor}
df.trial <- df.trial %>% 
  mutate(knower_level_cp_subset = factor(knower_level_cp_subset, levels = c("subset", "CP")),
         magnitude = factor(magnitude, levels = c("small", "large")))

```

## Demographics Stats

```{r summarize ppt}
df.ppt_knower_level <- df.ppt %>%
  count(knower_level_cp_subset)

df.ppt_knower_level_gender <- df.ppt %>%
  count(knower_level_cp_subset, gender)

df.ppt_summary <- df.ppt %>%
  group_by(knower_level_cp_subset) %>%
  summarise(mean_age = mean(age_years_cont),
            sd_age = sd(age_years_cont), 
            min_age = min(age_years_cont), 
            max_age = max(age_years_cont))
  

df.ppt %>%
  count(age_years) %>%
  knitr::kable()

df.ppt %>%
  count(gender) %>%
  knitr::kable()

df.ppt %>%
  count(knower_level_cp_subset, age_years) %>%
  knitr::kable()

df.ppt %>%
  count(knower_level_cp_subset, gender) %>%
  knitr::kable()

df.ppt %>%
  group_by(knower_level_cp_subset) %>%
  summarise(min_age = min(age_months), 
            max_age = max(age_months), 
            mean_age = mean(age_years_cont), 
            sd_age = sd(age_years_cont))
```

How many kids did not count?

```{r}
response_without_counting <- df.trial %>% 
  filter(!is.na(count) & is.na(set_chosen)) %>%
  group_by(knower_level_cp_subset, magnitude) %>%
  count()

response_without_counting
```

## Results

### Correct set chosen

Combining both overt set selection and correct counting (participants are correct if they've selected the correct set, or counted correctly.)

#### Descriptive Stats 
```{r}
df.summary_knower_level_correct_set_chosen <- df.trial %>%
  group_by(knower_level_cp_subset) %>%
  summarise(mean = mean(correct_set_chosen), sd = sd(correct_set_chosen))
df.summary_knower_level_correct_set_chosen

df.summary_magnitude_correct_set_chosen <- df.trial %>%
  group_by(magnitude) %>%
  summarise(mean = mean(correct_set_chosen), sd = sd(correct_set_chosen))
df.summary_magnitude_correct_set_chosen

df.summary_magnitude_correct_set_chosen <- df.trial %>%
  group_by(magnitude) %>%
  summarise(mean = mean(correct_set_chosen), sd = sd(correct_set_chosen))
df.summary_magnitude_correct_set_chosen
```

#### By trial

Doesn't seem to be any differences between small and large sets, only between CP and subset knowers.

```{r}
ggplot(data = df.trial, 
       mapping = aes(x = knower_level_cp_subset, y = correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    facet_grid(~ magnitude) + 
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = knower_level_cp_subset, y = correct_set_chosen, fill = knower_level_cp_subset)) + 
  geom_jitter(aes(group = id), 
              height = 0, 
              alpha = 0.5) +  
  geom_bar(stat = "summary", 
           fun.y = "mean") +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    geom_jitter(aes(group = id), 
              height = 0, 
              alpha = 0.3) +  
  facet_grid(magnitude ~ age_years) + 
  theme(legend.position = "none") + 
  labs(y = "Cardinal extension success (by trial)", 
       x = "Knower Level") 
```

#### By participant

Each dot is a participant. Accurracy in set chosen against age (years, continuous) looks linear.

```{r}
plot1 <- ggplot(data = df.trial %>%
         mutate(magnitude = factor(magnitude, levels = c("small", "large"), labels = c("small sets", "large sets")), 
                         knower_level_cp_subset = factor(knower_level_cp_subset, levels = c("subset", "CP"))) %>%
         group_by(id, magnitude, knower_level_cp_subset) %>%
         summarise(mean_correct_set_chosen = mean(correct_set_chosen, na.rm = TRUE)),
       mapping = aes(x = knower_level_cp_subset, y = mean_correct_set_chosen)) + 
  geom_violin(aes(fill = knower_level_cp_subset)) +
  geom_jitter(height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    facet_grid(~ magnitude) + 
    scale_fill_manual(values=cbPalette) + 
  geom_hline(yintercept = 0.5, linetype = 2) +
  theme(legend.position = "none") + 
  labs(y = "Prop. of correct set choice", 
       x = "Knower Level") 

ggplot(data = df.trial %>%
         group_by(id, magnitude, knower_level_cp_subset, age_years_cont) %>%
         summarise(mean_correct_set_chosen = mean(correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = age_years_cont, y = mean_correct_set_chosen)) + 
  geom_point()+
  geom_smooth(method='lm') +
  theme(legend.position = "none")

ggplot(data = df.trial %>%
                  mutate(knower_level_cp_subset = factor(knower_level_cp_subset, levels = c("subset", "CP")))%>%
          mutate(magnitude = factor(magnitude, levels = c("small", "large"), labels = c("small sets", "large sets"))) %>%
         group_by(id, magnitude, knower_level_cp_subset, age_years_cont) %>%
         summarise(mean_correct_set_chosen = mean(correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = age_years_cont, y = mean_correct_set_chosen, 
                     color = knower_level_cp_subset)) + 
  geom_jitter(height = 0, 
              alpha = 0.5) + 
  facet_grid(~magnitude) +
  ylim(0, 1) +
  geom_smooth(method='lm', aes(fill = knower_level_cp_subset)) +
  scale_fill_manual(values=cbPalette) + 
  scale_color_manual(values=cbPalette) +
  labs(x = "Age (years)",
       y = "Prop. of correct set choice", 
       fill = "", 
       color = "") +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  theme(text = element_text(size=13), 
        legend.position="none") 

```


```{r}
ggplot(data = df.trial %>%
         filter(knower_level_cp_subset == "CP") %>%
         group_by(id, magnitude, knower_level_cp_subset) %>%
         summarise(mean_correct_set_chosen = mean(correct_set_chosen, na.rm = TRUE)),
       mapping = aes(x = knower_level_cp_subset, y = mean_correct_set_chosen)) + 
  geom_violin(aes(fill = knower_level_cp_subset)) +
  geom_jitter(height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    facet_grid(~ magnitude) + 
  theme(legend.position = "none") + 
  labs(y = "Mean cardinal extension success (by participant)", 
       x = "Knower Level") 
```

Only 65% of CP-knowers were above chance (following binomial p < .05 --> chose correctly at least 5 out of 6 trials).
```{r}
df.trial_summary <- df.trial %>%
         group_by(id, knower_level_cp_subset) %>%
         summarise(mean_correct_set = mean(correct_set_chosen, na.rm = TRUE)) %>%
  group_by(knower_level_cp_subset) %>%
  summarise(n_total = n(),
            n_succeed = length(id[mean_correct_set == 6/6]), 
            prop_succeed =n_succeed / n_total)

df.trial_summary
```

#### T-tests
```{r}
t.test(df.trial %>% 
         filter(knower_level_cp_subset == "subset") %>%
         pull(correct_set_chosen),
       mu = 0.5)
#$statistic
#$parameter
#$p.values

report(t.test(df.trial %>% 
         filter(knower_level_cp_subset == "CP") %>%
         pull(correct_set_chosen),
       mu = 0.5))

report(t.test(df.trial %>% 
         filter(magnitude == "small") %>%
         pull(correct_set_chosen),
       mu = 0.5))

report(t.test(df.trial %>% 
         filter(magnitude == "large") %>%
         pull(correct_set_chosen),
       mu = 0.5))

report(t.test(df.trial %>% 
         filter(knower_level_cp_subset == "CP", magnitude == "small") %>%
         pull(correct_set_chosen),
       df.trial %>% 
         filter(knower_level_cp_subset == "subset", magnitude == "small") %>%
         pull(correct_set_chosen)))

report(t.test(df.trial %>% 
         filter(knower_level_cp_subset == "CP", magnitude == "large") %>%
         pull(correct_set_chosen),
       df.trial %>% 
         filter(knower_level_cp_subset == "subset", magnitude == "large") %>%
         pull(correct_set_chosen)))
```

#### Regressions

##### Base model
correct_set_chosen ~ magnitude + age_zscored + (1|id) + (1|quantity)
Effect of age

```{r}
#registered
#only age has an effect
#z-scored age based on previous work
fit.base <- glmer(correct_set_chosen ~ magnitude + age_zscored + (1|id) 
                + (1|trial_ratio)
                  , 
                  data = df.trial, family="binomial")
summary(fit.base)
report(fit.base)
Anova(fit.base, type = 3)
```

```{r}
#not-registered
#split by knower level
fit.base_cp <- glmer(correct_set_chosen ~ magnitude + age_zscored + (1|id) 
                     + (1|trial_ratio)
                     , 
                     data = df.trial %>% filter(knower_level_cp_subset == "CP"), 
                     family="binomial")
summary(fit.base_cp)
Anova(fit.base_cp, type = 3)

fit.base_subset <- glmer(correct_set_chosen ~ magnitude + age_zscored + (1|id) 
                         #+ (1|trial_ratio)
                      , 
                     data = df.trial %>% filter(knower_level_cp_subset == "subset"), 
                     family="binomial")
summary(fit.base_subset)
report(fit.base_subset)
Anova(fit.base_subset, type = 3)
```

##### Not registered: CP knowledge + magnitude, no age
correct_set_chosen ~ knower_level_cp_subset + magnitude + (1|id) + (1|trial_ratio)
Effect of knower level, no effect of magnitude.
**??? Model failed to converge**: Probably need to take out trial_ratio as a random effect? Maybe it's correlating too much with magnitude. 

```{r}
#not registered
fit.cp <- glmer(correct_set_chosen ~ knower_level_cp_subset + magnitude + (1|id) + (1|trial_ratio), data = df.trial, family="binomial")
summary(fit.cp)
report(fit.cp)
Anova(fit.cp, type = 3)
anova(fit.cp, fit.base, type = 3)
```

##### Registered: CP knowledge + magnitude + age
correct_set_chosen ~ knower_level_cp_subset + magnitude + age_zscored + (1|id) + (1|trial_ratio)
Effect of age, no effect of KL or magnitude.
**Model fail to converge**

```{r}
# knower level effect is wiped out by age effects
fit.cp_age <- glmer(correct_set_chosen ~ age_zscored + magnitude + knower_level_cp_subset + (1|id) 
                    + (1|trial_ratio)
                    , data = df.trial, family="binomial")
summary(fit.cp_age)
report(fit.cp_age)
Anova(fit.cp_age, type = 3)
anova(fit.cp_age, fit.base, type=3)
```

##### Not registered: CP knowledge * magnitude, no age
correct_set_chosen ~ knower_level_cp_subset * magnitude + (1|id) + (1|trial_ratio)
Effect of KL, no interaction.

```{r}
#not registered
fit.cp_int <- glmer(correct_set_chosen ~ knower_level_cp_subset * magnitude + (1|id) + (1|trial_ratio), data = df.trial, family="binomial")
summary(fit.cp_int)
Anova(fit.cp_int, type = 3)
```

##### Registered: CP knowledge * magnitude + age
correct_set_chosen ~ knower_level_cp_subset * magnitude + age_zscored + (1|id) + (1|trial_ratio)
Effect of age, no effect of KL or magnitude or interaction.

```{r}
fit.cp_age_int <- glmer(correct_set_chosen ~ age_zscored + magnitude * knower_level_cp_subset + (1|id) 
                        + (1|trial_ratio)
                        , 
                        data = df.trial, 
                        family="binomial")
summary(fit.cp_age_int)
report(fit.cp_age_int)
Anova(fit.cp_age_int, type = 3)
anova(fit.cp_age_int, fit.cp_age, type = 3)
```


### Correct set chosen (only overt selection of set)

#### By trial

Higher overt correct set chosen for large sets compared to small sets. This makes sense because some participants are able to subitize small sets without pointing to the screen and count (and the prompt might not be clear enough for them to do this overtly).

```{r}
ggplot(data = df.trial, 
       mapping = aes(x = knower_level_cp_subset, y = strict_correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    facet_grid(~ magnitude) + 
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = strict_correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = strict_correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  geom_bar(aes(fill = as.factor(age_years)),
           stat = "summary", 
           fun.y = "mean") +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  facet_grid(magnitude ~ knower_level_cp_subset) + 
  theme(legend.position = "none")
```

#### By participant

Each dot is a participant. Accurracy in set chosen against age (months) looks linear.

```{r}
ggplot(data = df.trial %>%
         group_by(id, magnitude, knower_level_cp_subset) %>%
         summarise(mean_strict_correct_set = mean(strict_correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = knower_level_cp_subset, y = mean_strict_correct_set)) + 
  geom_violin(aes(fill = knower_level_cp_subset)) +
  geom_jitter(height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    facet_grid(~ magnitude) + 
  theme(legend.position = "none")

ggplot(data = df.trial %>%
         group_by(id, magnitude, knower_level_cp_subset, age_months) %>%
         summarise(mean_strict_correct_set = mean(strict_correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = age_months, y = mean_strict_correct_set)) + 
  geom_point()+
  geom_smooth(method='lm') +
  theme(legend.position = "none")
```

### Correct count when correct set was chosen

#### Descriptive Stats 
```{r}
df.summary_knower_level_correct_count <- df.trial %>%
  group_by(knower_level_cp_subset) %>%
  summarise(mean = mean(correct_count_when_correct_set_chosen), sd = sd(correct_count_when_correct_set_chosen))
df.summary_knower_level_correct_count

df.summary_magnitude_correct_count <- df.trial %>%
  group_by(knower_level_cp_subset, magnitude) %>%
  summarise(mean = mean(correct_count_when_correct_set_chosen), sd = sd(correct_count_when_correct_set_chosen))
df.summary_magnitude_correct_count
```

```{r}
df.trial_summary_count <- df.trial %>%
         group_by(id, knower_level_cp_subset) %>%
         summarise(mean_correct_count_when_correct_set_chosen = mean(correct_count_when_correct_set_chosen, na.rm = TRUE)) %>%
  group_by(knower_level_cp_subset) %>%
  summarise(n_total = n(),
            n_succeed = length(id[mean_correct_count_when_correct_set_chosen <= 3/6]), 
            prop_succeed =n_succeed / n_total)

df.trial_summary_count
```

#### By trial

```{r}
ggplot(data = df.trial, 
       mapping = aes(x = knower_level_cp_subset, y = correct_count_when_correct_set_chosen)) +
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  facet_grid(~ magnitude) + 
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = correct_count_when_correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = correct_count_when_correct_set_chosen)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  geom_bar(aes(fill = as.factor(age_years)),
           stat = "summary", 
           fun.y = "mean") +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  facet_grid(magnitude ~ knower_level_cp_subset) + 
  theme(legend.position = "none")
```

#### By participant

All children are better at counting small sets compared to large sets, while there is no difference in performance of selecting the correct set. So either: 1) They are doing cardinal extension, but are making errors in the counting due to the larger set, or 2) The good performance for choosing the correct set just reflects mapping of animals to a side -- once the animals are gone, they just select the corresponding side without understanding the quantity relationship between the items and the animals.

```{r}
plot2 <- ggplot(data = df.trial %>%
         group_by(id, magnitude, knower_level_cp_subset) %>%
         mutate(magnitude = factor(magnitude, levels = c("small", "large"), labels = c("small sets", "large sets")), 
                         knower_level_cp_subset = factor(knower_level_cp_subset, levels = c("subset", "CP"))) %>%
         summarise(mean_correct_count = mean(correct_count_when_correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = knower_level_cp_subset, y = mean_correct_count)) + 
  geom_violin(aes(fill = knower_level_cp_subset)) +
  geom_jitter(height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
    facet_grid(~ magnitude) + 
  scale_fill_manual(values=cbPalette) + 
  theme(legend.position = "none") + 
  labs(y = "Prop. of correct numerical response", 
       x = "Knower Level") 

ggplot(data = df.trial %>%
         group_by(id, magnitude, knower_level_cp_subset, age_months) %>%
         summarise(mean_correct_count = mean(correct_count_when_correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = age_months, y = mean_correct_count)) + 
  geom_point()+
  geom_smooth(method='lm') +
  theme(legend.position = "none")

 ggplot(data = df.trial %>%
          mutate(magnitude = factor(magnitude, levels = c("small", "large"), labels = c("small sets", "large sets"))) %>%
         group_by(id, magnitude, knower_level_cp_subset, age_years_cont) %>%
         summarise(mean_correct_count = mean(correct_count_when_correct_set_chosen, na.rm = TRUE)), 
       mapping = aes(x = age_years_cont, y = mean_correct_count, 
                     color = knower_level_cp_subset)) + 
  geom_jitter(height = 0, 
              alpha = 0.5) + 
  facet_grid(~magnitude) +
  ylim(0, 1) +
  geom_smooth(method='lm', aes(fill = knower_level_cp_subset)) +
  scale_fill_manual(values=cbPalette) + 
  scale_color_manual(values=cbPalette) +
  labs(x = "Age (years)",
       y = "Prop. correct numerical response", 
       fill = "Knower Level", 
       color = "Knower Level") +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  theme(text = element_text(size=12), 
        legend.position="none")

combined_plot <- plot_grid(plot1, plot2, labels = c('A', 'B'))
legend <- get_legend(plot1 + 
                       theme(legend.position = "bottom") )
plot_grid(combined_plot, ncol=1,rel_heights = c(1, .1))
```

#### T-tests
```{r}

report(t.test(df.trial %>% 
         filter(knower_level_cp_subset == "CP") %>%
         pull(correct_count_when_correct_set_chosen),
       df.trial %>% 
         filter(knower_level_cp_subset == "subset") %>%
         pull(correct_count_when_correct_set_chosen)))

report(t.test(df.trial %>% 
         filter(knower_level_cp_subset == "CP", magnitude == "small") %>%
         pull(correct_count_when_correct_set_chosen),
       df.trial %>% 
         filter(knower_level_cp_subset == "subset", magnitude == "small") %>%
         pull(correct_count_when_correct_set_chosen)))

report(t.test(df.trial %>% 
         filter(knower_level_cp_subset == "CP", magnitude == "large") %>%
         pull(correct_count_when_correct_set_chosen),
       df.trial %>% 
         filter(knower_level_cp_subset == "subset", magnitude == "large") %>%
         pull(correct_count_when_correct_set_chosen)))
```

#### Regressions

##### Base model
correct_count_when_correct_set_chosen ~ magnitude + age_zscored + (1|id) + (1|trial_ratio)
Effect of age

```{r}
#registered
#only age has an effect
#z-scored age based on previous work
fit.base <- glmer(correct_count_when_correct_set_chosen ~ magnitude + age_zscored + (1|id) + (1|trial_ratio), data = df.trial, family="binomial")
summary(fit.base)
report(fit.base)
Anova(fit.base, type = 3)
```



##### Registered: CP knowledge + magnitude + age
correct_count_when_correct_set_chosen ~ CP knowledge + magnitude + age_zscored + (1|id) + (1|trial_ratio)
Effect of age

```{r}
#registered
#z-scored age based on previous work
fit.cp_age <- glmer(correct_count_when_correct_set_chosen ~ knower_level_cp_subset + magnitude + age_zscored + (1|id) + (1|trial_ratio), data = df.trial, family="binomial")
summary(fit.cp_age)
report(fit.cp_age)
Anova(fit.cp_age, type = 3)
anova(fit.cp_age, fit.base, type = 3)
```

##### Registered: CP knowledge * magnitude + age
correct_count_when_correct_set_chosen ~ CP knowledge * magnitude + age_zscored + (1|id) + (1|trial_ratio)
Effect of age

```{r}
#registered
#z-scored age based on previous work
fit.cp_age_int <- glmer(correct_count_when_correct_set_chosen ~ knower_level_cp_subset * magnitude + age_zscored + (1|id) + (1|trial_ratio), data = df.trial, family="binomial")
summary(fit.cp_age_int)
report(fit.cp_age_int)
Anova(fit.cp_age_int, type = 3)
anova(fit.cp_age_int, fit.cp_age, type = 3)
anova(fit.cp_age_int, fit.base, type = 3)
```

```{r}
fit.cp_age_int %>% 
  emmeans(specs = pairwise ~ knower_level_cp_subset * magnitude,
          adjust = "bonferroni") %>% 
  pluck("contrasts")
```


### Correct set but then wrong count 
```{r}
ggplot(data = df.trial %>%
  filter(correct_count == 0 & correct_set_chosen == 1))
    
df.trial %>%
  filter(correct_count == 0 & correct_set_chosen == 1) %>%
  group_by(knower_level_cp_subset, magnitude) %>%
  summarise(count = n())
  
```
### Approximate correct count

When allowed for off by 1 error, the subset knowers are better but still worse than the CP knowers. This is not very informative anyway.

```{r}
ggplot(data = df.trial %>% filter(magnitude == "large"), 
       mapping = aes(x = knower_level_cp_subset, y = correct_count_approx)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  facet_grid(~ magnitude) + 
  theme(legend.position = "none")

ggplot(data = df.trial %>% filter(magnitude == "large"), 
       mapping = aes(x = age_years, y = correct_count_approx)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  theme(legend.position = "none")

ggplot(data = df.trial %>% 
         filter(magnitude == "large") %>%
         group_by(id, knower_level_cp_subset, age_years) %>%
         summarise(mean_correct_count = mean(correct_count, na.rm = TRUE), 
                   mean_correct_count_approx = mean(correct_count_approx), na.rm = TRUE) %>%
         select(id, knower_level_cp_subset, age_years, mean_correct_count, mean_correct_count_approx) %>%
         pivot_longer(c(mean_correct_count, mean_correct_count_approx), names_to = "key", values_to = "mean_accuracy"), 
       mapping = aes(x = age_years, y = mean_accuracy, fill = key)) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  geom_bar(stat = "summary", 
           fun.y = "mean", 
           position = "dodge") +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange", 
               position = position_dodge(0.9)) +
  facet_grid(~ knower_level_cp_subset) + 
  guides(color = "none")
```

### Comparing different measures 

```{r}
ggplot(data = df.trial %>% 
         select(magnitude, knower_level_cp_subset, correct_set_chosen, correct_count_when_correct_set_chosen) %>%
          pivot_longer(-c(magnitude, knower_level_cp_subset), names_to = "variable", values_to = "value"), 
       mapping = aes(x = knower_level_cp_subset, y = value, color = variable)) + 
  facet_grid(~magnitude) +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange", 
               position = position_dodge(0.7)) +
  labs(y = "Cardinal extension success (by trial)", 
       x = "Trial Type")
```

### Error size

Absolute value of error decreases by age, and increases (slightly) as the target set correct count is bigger.

```{r}
ggplot(data = df.trial, 
       mapping = aes(x = knower_level_cp_subset, y = abs(count_error))) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  facet_grid(~ magnitude) + 
  ylim(NA, 10) +
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = abs(count_error))) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  ylim(NA, 10) +
  theme(legend.position = "none")

ggplot(data = df.trial, 
       mapping = aes(x = age_years, y = abs(count_error))) + 
  geom_jitter(aes(color = id), 
              height = 0, 
              alpha = 0.5) +  
  geom_bar(aes(fill = as.factor(age_years)),
           stat = "summary", 
           fun.y = "mean") +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "pointrange") +
  facet_grid(magnitude ~ knower_level_cp_subset) +
  ylim(NA, 10) +
  theme(legend.position = "none")

ggplot(data = df.trial,
       mapping = aes(x = target_count, y = abs(count_error))) + 
  geom_point()+
  geom_smooth(method='lm') +
  facet_grid(~ knower_level_cp_subset) +
  ylim(NA, 10) +
  theme(legend.position = "none")
```

### Highest count

#### With correct_set_chosen
Highest count does not explain additional variance.

```{r}
fit.set_hc <- glmer(correct_set_chosen ~ age_zscored + magnitude + knower_level_cp_subset + highest_count + (1|id) 
                       + (1|trial_ratio)
                       , 
                     data = df.trial %>%
                                  filter(!is.na(highest_count)),
                                family="binomial")
summary(fit.set_hc)
Anova(fit.set_hc, type = 3)

fit.set_hc_comp <- glmer(correct_set_chosen ~ magnitude + age_zscored + knower_level_cp_subset + (1|id) 
                          + (1|trial_ratio)
                          , 
                     data = df.trial %>%
                                  filter(!is.na(highest_count)),
                                family="binomial")
summary(fit.set_hc_comp)
Anova(fit.set_hc_comp, type = 3)
anova(fit.set_hc, fit.set_hc_comp)

```

```{r}
# knower level effect is wiped out by age effects
fit.set_hc_cp_only <- glmer(correct_set_chosen ~ highest_count + magnitude + age_zscored + (1|id) 
                       #+ (1|trial_ratio)
                       ,                    data = df.trial %>%
                         filter(knower_level_cp_subset == "CP") %>%
                                  filter(!is.na(highest_count)),
                                family="binomial")
summary(fit.set_hc_cp_only)
Anova(fit.set_hc_cp_only, type = 3)

fit.set_hc_cp_only_comp <- glmer(correct_set_chosen ~ magnitude + age_zscored + (1|id) 
                       #+ (1|trial_ratio)
                       ,                    data = df.trial %>%
                         filter(knower_level_cp_subset == "CP") %>%
                                  filter(!is.na(highest_count)),
                                family="binomial")
summary(fit.set_hc_cp_only_comp)
Anova(fit.set_hc_cp_only_comp, type = 3)
anova(fit.set_hc_cp_only, fit.set_hc_cp_only_comp, type = 3)

```

#### With correct_count

```{r}
fit.count_hc <- glmer(correct_count_when_correct_set_chosen ~ age_zscored + knower_level_cp_subset * magnitude + highest_count + (1|id) + (1|trial_ratio), 
                     data = df.trial %>%
                                  filter(!is.na(highest_count)),
                                family="binomial")
summary(fit.count_hc)
Anova(fit.count_hc, type = 3)

fit.count_hc_comp <- glmer(correct_count_when_correct_set_chosen ~ age_zscored + knower_level_cp_subset * magnitude + (1|id) + (1|trial_ratio), 
                     data = df.trial %>%
                                  filter(!is.na(highest_count)),
                                family="binomial")
summary(fit.count_hc_comp)
Anova(fit.count_hc_comp, type = 3)
anova(fit.count_hc, fit.count_hc_comp, type = 3)
```

```{r}
fit.count_hc_cp_only <- glmer(correct_count_when_correct_set_chosen ~ age_zscored + magnitude + highest_count + (1|id) + (1|trial_ratio), 
                     data = df.trial %>%
                                  filter(!is.na(highest_count)) %>%
                  filter(knower_level_cp_subset == "CP"),
                                family="binomial")
summary(fit.count_hc_cp_only)
Anova(fit.count_hc_cp_only, type = 3)

fit.count_hc_cp_only_comp <- glmer(correct_count_when_correct_set_chosen ~ age_zscored + magnitude + (1|id) + (1|trial_ratio), 
                     data = df.trial %>%
                                  filter(!is.na(highest_count))%>%
                  filter(knower_level_cp_subset == "CP"),
                                family="binomial")
summary(fit.count_hc_cp_only_comp)
Anova(fit.count_hc_cp_only_comp, type = 3)
anova(fit.count_hc_cp_only, fit.count_hc_cp_only_comp, type = 3)
```

